version: '3'

tasks:
  plan:
    desc: Run terragrunt plan
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - terragrunt plan

  apply:
    desc: Run terragrunt apply
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - terragrunt apply -auto-approve

  fmt:
    desc: Format terraform files
    cmds:
      - cd vpc && tofu fmt -recursive
      - cd security-groups && tofu fmt -recursive
      - cd vpc-endpoints && tofu fmt -recursive

  check-llm:
    desc: Run concise terragrunt plan optimized for machines / LLM
    dir: '{{.USER_WORKING_DIR}}'
    cmds:
      - terragrunt init -json | grep -v '"@level":"info"' | { grep -v grep || true; }
      - terragrunt validate -json
      - |
        terragrunt plan -json | jq -cM '
        if .type == "change_summary" or .type == "planned_change" then
          del(."@timestamp", ."@level")
        else
          select(."@level" != "info")      # drop info lines of other types
          | del(."@timestamp", ."@level")
        end
        '